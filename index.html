<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ML Mock 3D ‚Äî Zoom libre + indicador de ‚ÄúTama√±o real‚Äù</title>
  <!-- Visor 3D -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root{ --ml-yellow:#fff159; --ml-blue:#3483fa; --ok:#12b886; --ml-text:#333; --ml-bg:#f5f5f5; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--ml-text); background:var(--ml-bg); }
    header{ background:var(--ml-yellow); padding:14px 16px; position:sticky; top:0; z-index:10; display:flex; gap:12px; align-items:center; }
    header .logo{ width:124px; height:24px; background:#000; color:#fff; border-radius:4px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:14px; }
    header input{ flex:1; border:none; border-radius:6px; padding:10px 12px; outline:none; }
    .container{ max-width:980px; margin:16px auto; padding:0 12px; }
    .card{ background:#fff; border-radius:12px; box-shadow:0 6px 24px rgba(0,0,0,.06); overflow:hidden; }
    .grid{ display:grid; grid-template-columns:1fr; }
    .pad{ padding:16px; }
    .badges{ display:flex; gap:8px; margin:8px 0 12px; }
    .badge{ background:#eef3ff; color:#2b64d8; font-weight:600; font-size:12px; padding:6px 10px; border-radius:999px; }
    h1{ font-size:20px; margin:6px 0 8px; }
    .price{ font-size:24px; font-weight:700; margin:6px 0 12px; }
    .hint{ font-size:12px; color:#666; margin-top:6px; }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin:12px 0; }
    .btn{ padding:12px 14px; border:none; border-radius:10px; font-weight:700; cursor:pointer; }
    .btn-primary{ background:var(--ml-blue); color:#fff; }
    .btn-secondary{ background:#eef3ff; color:#2b64d8; }
    .actions{ display:flex; gap:10px; padding:12px; border-top:1px solid #eee; background:#fff; }
    .actions .btn{ flex:1; }
    model-viewer{ width:100%; background:#fff; border-radius:12px; --progress-bar-color: var(--ml-blue); }
    #heroMV{ height:54vh; pointer-events:none; border:1px solid #eee; } /* ‚Äúfoto‚Äù 3D sin controles */
    #mvWrap{ position:relative; }
    #mv{ height:60vh; border:1px solid #eee; transition: box-shadow .2s ease, border-color .2s ease; }
    #realBadge{
      position:absolute; top:10px; left:10px; padding:6px 10px; border-radius:999px;
      background:rgba(18,184,134,.12); color:#066a4b; font-weight:700; font-size:12px;
      display:none; backdrop-filter: blur(6px); border:1px solid rgba(18,184,134,.3);
    }
    #mv.real { box-shadow: 0 0 0 2px rgba(18,184,134,.6), 0 8px 30px rgba(18,184,134,.15); border-color: rgba(18,184,134,.6); }
    .strip{ display:flex; gap:8px; align-items:center; font-size:12px; color:#444; margin-top:10px; flex-wrap:wrap;}
    .pill{ background:#f2f2f2; border-radius:999px; padding:6px 10px; }
    @media (min-width:880px){ .grid{ grid-template-columns:1.1fr .9fr; gap:10px } #heroMV{ height:58vh } #mv{ height:65vh } }
  </style>
</head>
<body>
<header>
  <div class="logo">ML Mock</div>
  <input placeholder="Buscar productos, marcas y m√°s‚Ä¶" aria-label="Buscar" />
</header>

<main class="container">
  <section class="card">
    <div class="grid">
      <!-- ‚ÄúFoto‚Äù del mismo 3D (no es PNG) -->
      <div class="pad">
        <div class="badges"><div class="badge">NUEVO</div><div class="badge">3D/AR</div></div>
        <model-viewer id="heroMV"
          camera-controls="false" interaction-prompt="none" ar="false"
          environment-image="neutral" exposure="1.0" shadow-intensity="0.9"
          min-camera-orbit="0deg 65deg 1.2m" max-camera-orbit="0deg 65deg 1.2m"
          auto-rotate="false"></model-viewer>
        <p class="hint">La imagen superior est√° generada del mismo modelo 3D (sin PNG/JPG externas).</p>
      </div>

      <!-- Detalles + controles -->
      <div class="pad">
        <h1>Objeto demo (volumen tipo zapatilla 26√ó10√ó8 cm)</h1>
        <div class="price">$ 89.999</div>
        <p>Zoom libre + indicador cuando alcanza <strong>tama√±o real</strong> (1:1).</p>
        <div class="btns">
          <button class="btn btn-primary">Comprar ahora</button>
          <button class="btn btn-secondary" id="toggle">üëì Ver en 3D</button>
        </div>

        <div class="strip">
          <button class="btn btn-secondary" id="calibrate">üîß Calibrar 1:1 en este punto</button>
          <span class="pill">Radio actual: <span id="radNow">‚Äî</span></span>
          <span class="pill">Objetivo 1:1: <span id="radRef">‚Äî</span> (¬±5%)</span>
        </div>
        <p class="hint">Tip: pinch para acercar/alejar; cuando llegues al tama√±o real, el visor se <em>ilumina</em> y aparece ‚ÄúTama√±o real‚Äù.</p>
      </div>
    </div>

    <!-- Visor 3D con zoom libre + badge -->
    <div class="pad" id="viewerWrap" style="display:none; border-top:1px solid #eee; background:#fafafa">
      <div id="mvWrap">
        <model-viewer id="mv"
          camera-controls interaction-prompt="none"
          environment-image="neutral" exposure="1.0" shadow-intensity="0.9" autoplay>
        </model-viewer>
        <div id="realBadge">‚úÖ Tama√±o real</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-secondary">Agregar al carrito</button>
      <button class="btn btn-primary">Comprar ahora</button>
    </div>
  </section>
</main>

<script>
/*
  Genera un glTF 2.0 en memoria (sin archivos externos) y lo sirve v√≠a blob: URL.
  Es una ‚Äúcaja‚Äù met√°lica con tama√±o 26√ó10√ó8 cm, similar al volumen de una zapatilla.
*/
(function(){
  const L=0.26, W=0.10, H=0.08; // metros
  const sx=L/2, sy=W/2, sz=H/2;

  const faces = [
    [[1,0,0],  [ [sx,-sy,-sz],[sx, sy,-sz],[sx, sy, sz],[sx,-sy, sz] ]],
    [[-1,0,0], [ [-sx,-sy, sz],[-sx, sy, sz],[-sx, sy,-sz],[-sx,-sy,-sz] ]],
    [[0,1,0],  [ [-sx, sy,-sz],[ sx, sy,-sz],[ sx, sy, sz],[-sx, sy, sz] ]],
    [[0,-1,0], [ [-sx,-sy, sz],[ sx,-sy, sz],[ sx,-sy,-sz],[-sx,-sy,-sz] ]],
    [[0,0,1],  [ [-sx,-sy, sz],[ sx,-sy, sz],[ sx, sy, sz],[-sx, sy, sz] ]],
    [[0,0,-1], [ [-sx, sy,-sz],[ sx, sy,-sz],[ sx,-sy,-sz],[-sx,-sy,-sz] ]]
  ];

  const positions=[], normals=[], indices=[];
  let base=0;
  for(const [n, corners] of faces){
    for(const c of corners){ positions.push(...c); normals.push(...n); }
    indices.push(base,base+1,base+2, base,base+2,base+3);
    base+=4;
  }

  function f32(a){const b=new ArrayBuffer(a.length*4); new Float32Array(b).set(a); return b;}
  function u16(a){const b=new ArrayBuffer(a.length*2); new Uint16Array(b).set(a); return b;}

  const pos=f32(positions), nor=f32(normals), idx=u16(indices);

  function concatAligned(arrs){
    let total=0,parts=[];
    for(const b of arrs){
      const pad=(4-(b.byteLength%4))%4;
      parts.push(b,new ArrayBuffer(pad));
      total+=b.byteLength+pad;
    }
    const out=new Uint8Array(total);
    let o=0;
    for(const p of parts){ out.set(new Uint8Array(p),o); o+=p.byteLength; }
    return out.buffer;
  }

  const bin = concatAligned([pos, nor, idx]);

  const posOff=0;
  const norOff=pos.byteLength + ((4-(pos.byteLength%4))%4);
  const idxOff=norOff + nor.byteLength + ((4-(nor.byteLength%4))%4);

  const bufURL=URL.createObjectURL(new Blob([bin],{type:"application/octet-stream"}));

  const gltf = {
    asset:{version:"2.0"},
    buffers:[{uri:bufURL, byteLength:bin.byteLength}],
    bufferViews:[
      {buffer:0,byteOffset:posOff,byteLength:pos.byteLength,target:34962},
      {buffer:0,byteOffset:norOff,byteLength:nor.byteLength,target:34962},
      {buffer:0,byteOffset:idxOff,byteLength:idx.byteLength,target:34963}
    ],
    accessors:[
      {bufferView:0,byteOffset:0,componentType:5126,count:24,type:"VEC3",min:[-sx,-sy,-sz],max:[sx,sy,sz]},
      {bufferView:1,byteOffset:0,componentType:5126,count:24,type:"VEC3"},
      {bufferView:2,byteOffset:0,componentType:5123,count:36,type:"SCALAR"}
    ],
    materials:[{pbrMetallicRoughness:{baseColorFactor:[0.2,0.2,0.22,1],metallicFactor:0.5,roughnessFactor:0.35}}],
    meshes:[{primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0}]}],
    nodes:[{mesh:0}],
    scenes:[{nodes:[0]}],
    scene:0
  };

  const gltfURL=URL.createObjectURL(new Blob([JSON.stringify(gltf)],{type:"model/gltf+json"}));

  // Asignar al ‚Äúhero‚Äù (foto 3D) y al visor
  document.getElementById('heroMV').src = gltfURL;
  const mv = document.getElementById('mv');
  mv.src = gltfURL;

  // --- UX: Zoom libre + ‚ÄúTama√±o real‚Äù ---
  // Definimos un radio de c√°mara de referencia (baseline) que consideramos 1:1 para este objeto.
  // Lo pod√©s recalibrar en vivo; guardamos en localStorage.
  const STORAGE_KEY = 'ml_mock_real_radius';
  const DEFAULT_REF = 1.20; // metros (punto inicial pensado para 26√ó10√ó8 cm con FOV por defecto)
  let refRadius = Number(localStorage.getItem(STORAGE_KEY) || DEFAULT_REF);

  const badge = document.getElementById('realBadge');
  const radNowEl = document.getElementById('radNow');
  const radRefEl = document.getElementById('radRef');
  const mvWrap = document.getElementById('mvWrap');

  radRefEl.textContent = `${refRadius.toFixed(2)} m`;

  function updateBadge(){
    const o = mv.getCameraOrbit();
    const r = parseFloat(o.radius);
    radNowEl.textContent = `${r.toFixed(2)} m`;

    // Umbral de ‚Äúigual‚Äù (¬±5%)
    const within = Math.abs(r - refRadius) <= refRadius * 0.05;
    if(within){
      badge.style.display = 'inline-flex';
      mv.classList.add('real');
    }else{
      badge.style.display = 'none';
      mv.classList.remove('real');
    }
  }

  mv.addEventListener('camera-change', updateBadge);
  mv.addEventListener('load', updateBadge);

  // Bot√≥n: Calibrar 1:1 en este punto
  document.getElementById('calibrate').addEventListener('click', ()=>{
    const o = mv.getCameraOrbit();
    refRadius = parseFloat(o.radius);
    localStorage.setItem(STORAGE_KEY, String(refRadius));
    radRefEl.textContent = `${refRadius.toFixed(2)} m`;
    updateBadge();
  });

  // Toggle visor
  const wrap = document.getElementById('viewerWrap');
  document.getElementById('toggle').addEventListener('click', ()=>{
    const open = wrap.style.display === 'block';
    wrap.style.display = open ? 'none' : 'block';
    if(!open) { wrap.scrollIntoView({behavior:'smooth'}); updateBadge(); }
  });
})();
</script>
</body>
</html>
